services:
  kafka:
    image: "bitnami/kafka:4.0.0"
    network_mode: "host"
    environment:
      KAFKA_CFG_NODE_ID: 1
      KAFKA_CFG_PROCESS_ROLES: controller,broker
      KAFKA_CFG_LISTENERS: SASL_SSL://localhost:4093,PLAINTEXT_HOST://localhost:4092,PLAINTEXT://localhost:24092,SSL://localhost:24093,SASL_PLAINTEXT://localhost:14093
      KAFKA_CFG_ADVERTISED_LISTENERS: SASL_SSL://localhost:4093,PLAINTEXT_HOST://localhost:4092,PLAINTEXT://localhost:24092,SSL://localhost:24093,SASL_PLAINTEXT://localhost:14093
      KAFKA_CFG_INTER_BROKER_LISTENER_NAME: PLAINTEXT_HOST
      KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT,SSL:SSL,SASL_SSL:SASL_SSL,SASL_PLAINTEXT:SASL_PLAINTEXT,PLAINTEXT2:PLAINTEXT
      KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: 1@localhost:24092
      KAFKA_CLIENT_LISTENER_NAME: PLAINTEXT_HOST
      KAFKA_CFG_CONTROLLER_LISTENER_NAMES: PLAINTEXT
      KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_CFG_DELEGATION_TOKEN_SECRET_KEY: 'foo'

      # SASL
      KAFKA_CFG_SASL_ENABLED_MECHANISMS: PLAIN,SCRAM-SHA-256,SCRAM-SHA-512
      KAFKA_CFG_SASL_MECHANISM_CONTROLLER_PROTOCOL: PLAIN
      KAFKA_CFG_SASL_MECHANISM_INTER_BROKER_PROTOCOL: PLAIN
      KAFKA_CLIENT_USERS: client,client-sha512,admin
      KAFKA_CLIENT_PASSWORDS: client-password,client-password,admin-secret

      # SSL
      KAFKA_TLS_TYPE: JKS
      KAFKA_CERTIFICATE_PASSWORD: confluent
      KAFKA_SSL_CLIENT_AUTH: "required"
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_NUM_PARTITIONS: 3

    volumes:
      - ../kafka/truststore/kafka.truststore.jks:/bitnami/kafka/config/certs/kafka.truststore.jks:ro
      - ../kafka/keystore/kafka.keystore.jks:/bitnami/kafka/config/certs/kafka.keystore.jks:ro
      - ./client.config:/etc/kafka/client.config
      - ./tokens/:/etc/kafka/tokens:Z

  create-delegation-token:
    image: "bitnami/kafka:4.0.0"
    network_mode: "host"
    user: root
    command: >
     /bin/bash -c "
        kafka-delegation-tokens.sh --bootstrap-server localhost:24093 --create --max-life-time-period -1 --command-config /etc/kafka/client.config --renewer-principal User:admin | awk 'NR>5 {print $1, '\t', $2}' > /etc/kafka/tokens/delegation-tokens.env"
    volumes:
      - ../kafka/truststore/kafka.truststore.jks:/bitnami/kafka/config/certs/kafka.truststore.jks:ro
      - ../kafka/keystore/kafka.keystore.jks:/bitnami/kafka/config/certs/kafka.keystore.jks:ro
      - ./client.config:/etc/kafka/client.config
      - ./tokens/:/etc/kafka/tokens:Z
