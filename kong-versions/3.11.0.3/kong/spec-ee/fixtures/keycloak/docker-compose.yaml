services:
  keycloak:
    image: quay.io/keycloak/keycloak:26.3
    command: start-dev --import-realm
    volumes:
      - ./test.json:/opt/keycloak/data/import/test.json
      - ./truststore.jks:/tmp/truststore.jks
      - ./server.crt:/tmp/server.crt
      - ./server.key:/tmp/server.key
    environment:
      KEYCLOAK_USER: admin
      KEYCLOAK_PASSWORD: test
      VIRTUAL_PORT: 8080,8443
      DB_VENDOR: h2
      JAVA_OPTS_APPEND: -Dkeycloak.migration.strategy=OVERWRITE_EXISTING -Xms64m -Xmx128m
      KC_HTTPS_TRUST_STORE_FILE: /tmp/truststore.jks
      KC_HTTPS_TRUST_STORE_PASSWORD: password
      KC_HTTPS_CLIENT_AUTH: request
      KC_HTTPS_PROTOCOLS: TLSv1.2
      KC_HTTPS_CERTIFICATE_FILE: /tmp/server.crt
      KC_HTTPS_CERTIFICATE_KEY_FILE: /tmp/server.key
      KC_FEATURES: dpop
    healthcheck:
      interval: 5s
      retries: 10
      test:
      - CMD
      - timeout
      - 3s
      - bash
      - -c
      - ':> /dev/tcp/127.0.0.1/8080'
      timeout: 10s
    ports:
      - "127.0.0.1:18080:8080"
      - "127.0.0.1::8443"
    restart: on-failure
    stop_signal: SIGKILL
